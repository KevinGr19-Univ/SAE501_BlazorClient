@page "/renderer"
@using ClientBlazor_v1.Components
@using ClientBlazor_v1.Components.RoomView
@using ClientBlazor_v1.Components.Utils
@using ClientBlazor_v1.Models
@using ClientBlazor_v1.Models.RoomObjects
@using ClientBlazor_v1.Services
@using ClientBlazor_v1.Utils
@using ClientBlazor_v1.ViewModels.JS
@using ClientBlazor_v1.ViewModels.JS.RoomObject

<PageTitle>Salle 3D</PageTitle>

<div id="renderer_container">

    <canvas id="renderer" touch-action="none"></canvas>

        @if(RoomSceneVM is not null){
            <div class="renderer_navbar">
                <div class="renderer_navbar_btn" @onclick=RoomSceneVM.SetGizmoPos title="Translation"><img src="images/move.png"/></div>
                <div class="renderer_navbar_btn" @onclick=RoomSceneVM.SetGizmoRot title="Rotation"><img src="images/rotate.png" /></div>
                <div class="renderer_navbar_btn" @onclick=RoomSceneVM.SetGizmoScale title="Taille"><img src="images/scale.png" /></div>
                <div class="renderer_navbar_btn" @onclick=RoomSceneVM.SetFocusToSelected title="Centrer vers l'objet sélectionné"><img src="images/focus_element.png" /></div>
                <div class="renderer_navbar_btn" @onclick=RoomSceneVM.SetFocusToCenter title="Centrer vers l'origine"><img src="images/focus_world.png" /></div>
                <Compass VM="RoomSceneVM.CompassVM" OrientationOffset="RoomSceneVM.Room?.NorthOrientation ?? 0"></Compass>
            </div>
        }

    <div class="renderer_ui" style="left: 0;">
        @if(RoomSceneVM is not null)
        {
            <FWindow CloseButton="false">
                <Header>
                    <span>@(RoomSceneVM.Room?.Name ?? "Chargement...")</span>
                </Header>
                <Content>
                    <FSubWindow>
                        <Header><span>Objets</span></Header>
                        <Content>
                            @{
                                RoomObjectSorter<RoomObjectVM> sortedVMs = RoomObjectSorter<RoomObjectVM>.SortObjects(RoomSceneVM.ObjectVMs, (vm) => vm.RoomObject);
                            }

                            @foreach(var section in new[]{
                                new{ Title = "Capteurs", VMs = sortedVMs.Sensors },
                                new{ Title = "Actionneurs", VMs = sortedVMs.Actionnables },
                                new{ Title = "Equipements", VMs = sortedVMs.Equipments },
                            }){
                                <span><b>@(section.Title)</b> (@(section.VMs.Count))</span>
                                @if(section.VMs.Count > 0)
                                {
                                    <ul>
                                        @foreach(var roomObjectVM in section.VMs)
                                        {
                                            <li class="objectLink @(RoomSceneVM.VisibleObjectVMs.Contains(roomObjectVM) ? "isVisible" : "")" 
                                            @onclick=roomObjectVM.Select>@roomObjectVM.RoomObject.GetName()</li>
                                        }
                                    </ul>
                                }
                            }
                        </Content>
                    </FSubWindow>
                    <FSubWindow>
                        <Header><span>Actions</span></Header>
                        <Content>
                            <button>Ajouter un équipement</button>
                        </Content>
                    </FSubWindow>
                </Content>
            </FWindow>
        }
    </div>

    <div class="renderer_ui" style="right: 0;">
        @if(RoomSceneVM is not null)
        {
            @foreach(var objVM in RoomSceneVM.VisibleObjectVMs)
            {
                @if(objVM is DoorVM doorVM) { <DoorEditor VM="doorVM"></DoorEditor> }
                else if(objVM is SensorVM sensorVM) { <SensorEditor VM="sensorVM"></SensorEditor> }
            }
        }
    </div>

    <Modal @ref=_addObjectModal>
        <Title>Ajouter un équipement</Title>
        <Content>
            <div class="input-box">
                <label for="room-building">Type</label>
                <InputSelect id="room-building" @bind-Value="RoomSceneVM.RoomObjectTypeToAdd" class="form-select">
                    <option value="null">- Séléctionnez le type de nouvel objet -</option>
                    @foreach (var type in RoomSceneVM.RoomObjectTypes)
                    {
                        <option value="@type">@type</option>
                    }
                </InputSelect>
            </div>
        </Content>
        <Buttons>
            <button type="button" class="btn btn-primary" @onclick=Click_AddObject>Ajouter</button>
            <button type="button" class="btn btn-secondary" @onclick=_addObjectModal.Close>Annuler</button>
        </Buttons>
    </Modal>
</div>

@inject IJSRuntime JS
@inject IService<Room> roomService
@inherits UIUpdatableComponent
@code{
    [SupplyParameterFromQuery]
    public int RoomId { get; set; }

    public RoomSceneVM RoomSceneVM { get; set; }

    public override IUpdateUI Updatable => RoomSceneVM;

    private Modal _addObjectModal;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var module = await JS.InvokeAsync<IJSObjectReference>("import", "/js/roomScene.js");
            var sceneObj = await module.InvokeAsync<IJSInProcessObjectReference>("getScene");

            RoomSceneVM = new(roomService, sceneObj);

            TryBind();
            UpdateUI();

            await RoomSceneVM.LoadRoom(RoomId);
        }
    }

    public void Click_AddObject()
    {
        _addObjectModal.Close();
    }

}